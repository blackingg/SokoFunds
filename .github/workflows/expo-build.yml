name: Expo EAS Build and Release (Android)

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Build the APK
  build-apk:
    runs-on: ubuntu-latest
    outputs:
      apk_path: ${{ steps.download.outputs.path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build Android APK (Preview)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform android --profile preview --non-interactive --json > build-preview.json
          APK_URL=$(jq -r '.[0].artifacts.buildUrl' build-preview.json)
          curl -L $APK_URL -o SokoFunds.apk

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: SokoFunds.apk

  # Job 2: Build the AAB
  build-aab:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build Android AAB (Production)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform android --profile production --non-interactive --json > build-prod.json
          AAB_URL=$(jq -r '.[0].artifacts.buildUrl' build-prod.json)
          curl -L $AAB_URL -o SokoFunds.aab

      - name: Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: SokoFunds.aab

  # Job 3: Create the Rich Release
  release:
    needs: [build-apk, build-aab]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create Rich GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/SokoFunds.apk
            dist/SokoFunds.aab
          tag_name: v1.0.${{ github.run_number }}
          name: SokoFunds Release v1.0.${{ github.run_number }}
          body: |
            ## SokoFunds Android Release
            
            A new version of **SokoFunds** is ready for deployment! This build was automatically generated by GitHub Actions.

            ### Download & Install
            
            | Asset | Type | Usage |
            | :--- | :--- | :--- |
            | **[Download APK](https://github.com/${{ github.repository }}/releases/download/v1.0.${{ github.run_number }}/SokoFunds.apk)** | `.apk` | **Direct Install** on Android devices. Best for testing. |
            | **[Download AAB](https://github.com/${{ github.repository }}/releases/download/v1.0.${{ github.run_number }}/SokoFunds.aab)** | `.aab` | **Google Play Store** submission format. |

            ---

            ### Release Details
            
            - **Build ID:** `${{ github.run_id }}`
            - **Sequence:** `#${{ github.run_number }}`
            - **Commit:** `${{ github.sha }}`
            - **Branch:** `${{ github.ref_name }}`
            - **Timestamp:** `${{ github.event.head_commit.timestamp }}`

            ### üõ† Change Summary
            > ${{ github.event.head_commit.message }}

            ---
            *Built with ‚ù§Ô∏è by blackingg*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
